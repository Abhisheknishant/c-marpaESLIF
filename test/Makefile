CLANG_C_FLAGS = -Weverything -Wno-vla -Wno-covered-switch-default -Werror
GCC_C_FLAGS = -Wall -Wextra -Werror

ifeq ($(notdir $(CC)), clang)
  CFLAGS ?= $(CLANG_C_FLAGS)
else ifeq ($(notdir $(CC)), suncc)
  CFLAGS ?= -errwarn -errtags
  C_OUTPUT_FILE := -o
else ifeq ($(notdir $(CC)), cl6x)
  CFLAGS ?= --display_error_number --emit_warnings_as_errors --issue_remarks
  C_OUTPUT_FILE := --output_file=
else ifeq ($(notdir $(CC)), pgcc)
  CFLAGS ?= -Minform=inform -c11
  C_OUTPUT_FILE := -o
else ifeq ($(notdir $(CC)), pgc++)
  CFLAGS ?= --display_error_number -Minform=inform -Werror
  C_OUTPUT_FILE := -o
else ifeq ($(notdir $(CC)), xlc)
  CFLAGS ?= $(CLANG_C_FLAGS)
  C_OUTPUT_FILE := -o
else ifeq ($(notdir $(CC)), icc)
  CFLAGS ?= -w3 -Werror
  C_OUTPUT_FILE := -o
else
  CFLAGS ?= $(filter-out -Werror,$(GCC_C_FLAGS))
endif

CLANG_CXX_FLAGS = -Weverything -Werror
GCC_CXX_FLAGS = -Wall -Wextra -Werror

ifeq ($(notdir $(CXX)), clang)
  CXXFLAGS ?= $(CLANG_CXX_FLAGS)
else ifeq ($(notdir $(CXX)), sunCC)
  CXXFLAGS ?= -errwarn=%all -errtags=yes
  CXX_OUTPUT_FILE := -o
else ifeq ($(notdir $(CXX)), pgc++)
  CXXFLAGS ?= --display_error_number -Minform=inform -Werror
  CXX_OUTPUT_FILE := -o
else ifeq ($(notdir $(CC)), cl6x)
  CXXFLAGS ?= --display_error_number --emit_warnings_as_errors --issue_remarks
  CXX_OUTPUT_FILE := --output_file=
else ifeq ($(notdir $(CXX)), xlc++)
  CXXFLAGS ?= $(CLANG_CXX_FLAGS)
  CXX_OUTPUT_FILE := -o
else ifeq ($(notdir $(CXX)), icpc)
  CXXFLAGS ?= $(GCC_CXX_FLAGS)
  CXX_OUTPUT_FILE := -o
else
  CXXFLAGS ?= $(filter-out -Werror,$(GCC_CXX_FLAGS))
endif

C_OUTPUT_FILE ?= --output=
CXX_OUTPUT_FILE ?= --output=

NULL =

TESTS = \
	array-param \
	cast \
	const \
	deprecated \
	likely \
	message \
	noinline \
	no-return \
	pure \
	restrict \
	sentinel \
	static-assert \
	stringify \
	unknown-pragmas \
	unavailable \
	unreachable \
	visibility \
	warn \
	warn-unused-result \
	$(NULL)

CLEANFILES = \
	$(TESTS) \
	$(TESTS:=-cpp) \
	$(TESTS:=.cpp)

all: $(TESTS) $(TESTS:=-cpp) .gitignore Makefile.msvc

%.cpp: %.c
	cp -a $^ $@

%-cpp: %.cpp
	$(CXX) $(CXXFLAGS) $(CXX_OUTPUT_FILE)$@ $(^:.c=.cpp)

%: %.c
	$(CC) $(CFLAGS) $(C_OUTPUT_FILE)$@ $^

define GEN_GCC_C_WARNINGS
$(1): $(1:=.c)
	$(CC) $(filter-out -Werror,$(CFLAGS)) $(C_OUTPUT_FILE)$(1) $(1:=.c)
endef

define GEN_GCC_CXX_WARNINGS
$(1)-cpp: $(1:=.cpp)
	$(CXX) $(filter-out -Werror,$(CXXFLAGS)) $(CXX_OUTPUT_FILE)$(1) $(1:=.cpp)
endef

.gitignore: Makefile
	@echo "# Generated by Makefile. Do not edit." > $@
	@$(foreach file,$(CLEANFILES),echo "/$(file)" >> $@;)
	@echo "/.gitignore" >> $@

Makefile.msvc: Makefile
	@echo -e "# Generated by Makefile. Do not edit.\r" > $@
	@echo -e "CC = cl\r" >> $@
	@echo -e "CXX = \x24(CC)\r" >> $@
	@echo -e "\r" >> $@

	@echo -e "CFLAGS = /nologo /Wall /wd4464 /wd4514\r" >> $@
	@echo -e "CXXFLAGS = \x24(CFLAGS)\r" >> $@
	@echo -e "\r" >> $@

	@echo -e "TESTS = \x5c\r" >> $@
	@$(foreach file,$(TESTS),echo -e "\t$(file:=.exe) $(file:=-cpp.exe) \x5c\r" >> $@;)
	@echo -e "\t\x24(NULL)\r\n\r" >> $@

	@echo -e "CLEANFILES = \x24(TESTS) \x5c\r" >> $@
	@$(foreach file,$(TESTS),echo -e "\t$(file:=.cpp) $(file:=.obj) $(file:=.lib) $(file:=-cpp.exp) $(file:=-cpp.lib) \x5c\r" >> $@;)
	@echo -e "\t\x24(NULL)\r\n\r" >> $@

	@echo -e "all: \x24(TESTS)\r\n\r" >> $@
	@echo -e "clean:\r\n\tdel /Q \x24(CLEANFILES)\r\n\r" >> $@

	@$(foreach file,$(TESTS),echo -e "$(file:=.exe): $(file:=.c)\r\n\t\x24(CC) \x24(CFLAGS) /Fe\x24(@) \x24(?)\r\n$(file:=.cpp): $(file:=.c)\r\n\tcopy /Y \x24(?) \x24(@) >NUL\r\n$(file:=-cpp.exe): $(file:=.cpp)\r\n\t\x24(CXX) \x24(CXXFLAGS) /Fe\x24(@) \x24(?)\r\n\r" >> $@;)

clean:
	rm -f $(CLEANFILES)

.PHONY: clean all

ifeq ($(notdir $(CC)), gcc)
$(foreach tgt,unavailable warn unknown-pragmas,$(eval $(call GEN_GCC_C_WARNINGS,$(tgt))))
endif

ifeq ($(notdir $(CXX)), g++)
$(foreach tgt,unavailable warn unknown-pragmas,$(eval $(call GEN_GCC_CXX_WARNINGS,$(tgt))))
endif
